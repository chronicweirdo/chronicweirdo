<!DOCTYPE html>

<html>
<head>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta charset="utf-8"/>
<link href="favicon.png?" rel="shortcut icon" type="image/x-icon"/>
    <style>
        #content {
            text-align: center;
        }
        img {
            margin: 0 auto;
            max-width: 100%;
        }
        #left {
            position: fixed;
            width: 20%;
            height: 100%;
            left: 0;
            top: 0;
        }
        #right {
            position: fixed;
            width: 20%;
            height: 100%;
            right: 0;
            top: 0;
        }
        #center {
            position: fixed;
            width: 60%;
            height: 100%;
            left: 20%;
            top: 0;
        }
    </style>
    <script>
        function getPixelKey(pixelData) {
            return pixelData[0] + "_" + pixelData[1] + "_" + pixelData[2]
        }

        function getKeyColor(key) {
            var cs = key.split("_")
            return [parseInt(cs[0]), parseInt(cs[1]), parseInt(cs[2])]
        }

        function increaseRepresentation(pixelMap, pixelData) {
            var k = getPixelKey(pixelData)
            //console.log(k)
            if (pixelMap[k] !== undefined) {
                pixelMap[k] = pixelMap[k] + 1
            } else {
                pixelMap[k] = 1
            }
        }

        function getMostRepresented(pixelMap) {
            var total = 0
            var items = Object.keys(pixelMap).map(function(key) {
                total = total + pixelMap[key]
                return [key, pixelMap[key]];
            })
            items.sort(function(first, second) {
                return second[1] - first[1];
            });

            // select items based on representation (difference in representation)
            var color = getKeyColor(items[0][0])
            var selectedColors = [[color, items[0][1]]]
            var selectedColorsNumber = 1
            for (var i = 1; i < items.length && (items[i][1] / items[0][1] > .1); i++) {
                var additionalColor = getKeyColor(items[i][0])
                selectedColors.push([additionalColor, items[i][1]])
                color[0] = color[0] + additionalColor[0]
                color[1] = color[1] + additionalColor[1]
                color[2] = color[2] + additionalColor[2]
                selectedColorsNumber = i
            }
            //console.log(selectedColors)
            color[0] = Math.floor(color[0] / selectedColorsNumber)
            color[1] = Math.floor(color[1] / selectedColorsNumber)
            color[2] = Math.floor(color[2] / selectedColorsNumber)

            //var key = items[0][0]
            //var cs = key.split("_")
            //return [parseInt(cs[0]), parseInt(cs[1]), parseInt(cs[2])]
            return color
        }
        function invert(color) {
            return [
                255 - color[0],
                255 - color[1],
                255 - color[2]
            ]
        }
        function getTextColor(bg) {
            // Counting the perceptive luminance - human eye favors green color... 
            var luminance = ( 0.299 * bg[0] + 0.587 * bg[1] + 0.114 * bg[2])/255;

            if (luminance > 0.5) {
                return [0, 0, 0]
            } else {
                return [255, 255, 255]
            }
        }
        function getImage() {
            var content = document.getElementById("content")
            var img = content.getElementsByTagName("img")[0]
            //console.log(img)
            return img
        }
        function getOriginalImageWidth() {
            return getImage().naturalWidth
        }
        function getOriginalImageHeight() {
            return getImage().naturalHeight
        }
        function getSuggestedBackgroundColor() {
            var img = getImage()
            var canvas = document.createElement('canvas');
            canvas.width = getOriginalImageWidth()
            canvas.height = getOriginalImageHeight()
            //console.log(canvas.width)
            //console.log(canvas.height)
            var context = canvas.getContext('2d')
            context.drawImage(img, 0, 0)
            var pixelMap = {}
            // firefox disable cors for testing
            // about:config
            // security.fileuri.strict_origin_policy
            // console.log(context.getImageData(0, 0, 1, 1).data)
            for (var y = 0; y < getOriginalImageHeight(); y++) {
                increaseRepresentation(pixelMap, context.getImageData(0, y, 1, 1).data)
                increaseRepresentation(pixelMap, context.getImageData(getOriginalImageWidth() - 1, y, 1, 1).data)
            }
            for (var x = 1; x < getOriginalImageWidth() - 1; x++) {
                increaseRepresentation(pixelMap, context.getImageData(x, 0, 1, 1).data)
                increaseRepresentation(pixelMap, context.getImageData(x, getOriginalImageHeight() - 1, 1, 1).data)
            }
            //console.log(pixelMap)
            var color = getMostRepresented(pixelMap)

            document.body.style.background="rgb(" + color[0] + "," + color[1] + "," + color[2] + ")"
            //var textColor = invert(color)
            var textColor = getTextColor(color)
            //console.log(textColor)
            document.body.style.color="rgb(" + textColor[0] + "," + textColor[1] + "," + textColor[2] + ")"
            canvas.remove()
        }

        var data = [
            "2020/2020.png",
            "2020/20201028.png",
            "2019/201910301104.jpeg",
            "2019/201909261405.jpeg",
            "2019/201909261355.jpeg",
            "2019/201909071040.jpeg",
            "2019/201908252102.jpeg",
            "2019/201908252101.jpeg",
            "2019/201908182226.jpeg",
            "2019/201908151914.jpeg",
            "2019/201908111710.jpeg",
            "2019/201908031754.jpeg",
            "2019/201908031753.jpeg",
            "2019/201908031730.jpeg",
            "2019/201908022105.jpeg",
            "2019/201907211317.jpeg",
            "2019/201907211312.jpeg",
            "2019/201906153.jpg",
            "2019/201906152.jpg",
            "2019/201906151.jpg",
            "2019/20190717.jpeg",
            "2019/20190712.jpeg",
            "2019/20190710.jpeg"
        ]
        var current = 0
        function load(index) {
            var img = document.createElement("img")
            img.src = data[index]
            var content = document.getElementById("content")
            content.innerHTML = ""
            content.appendChild(img)
            img.onload = function() {
                getSuggestedBackgroundColor()
            }
        }
        function next() {
            if (current > 0) {
                current = current - 1
                load(current)
            }
        }
        function previous() {
            if (current < data.length - 1) {
                current = current + 1
                load(current)
            }
        }
    </script>
    <title>chronicweirdo</title>
</head>
<body>
<!--nav>
<a onclick="next()">next</a>
<a onclick="previous()">previous</a>
</nav-->
<div id="content">

</div>
<div id="left" onclick="next()"></div>
<div id="center"></div>
<div id="right" onclick="previous()"></div>
<script>
    //document.getElementById("left").addEventListener("click", (event) => next())
    //document.getElementById("right").addEventListener("click", (event) => next())
    load(current)
</script>
</body>
</html>
